var l1ValuePaths = [
	{
		name: "L1 File",
		path: "LAYER 1/FILE SELECT/Value",
		type: "integer",
	},
	{
		name: "L1 Folder",
		path: "LAYER 1/FOLDER SELECT/Value",
		type: "integer",
	},
	{
		name: "L1 Intensity",
		path: "LAYER 1/INTENSITY/Value",
		type: "float",
	},
	{
		name: "L1 InFrame",
		path: "LAYER 1/IN FRAME/Value",
		type: "integer",
	},
	{
		name: "L1 OutFrame",
		path: "LAYER 1/OUT FRAME/Value",
		type: "integer",
	},
	{
		name: "L1 Playmode",
		path: "LAYER 1/PLAY MODE/Value",
		type: "enum",
	},
	{
		name: "L1 Framingmode",
		path: "LAYER 1/FRAMING MODE/Value",
		type: "enum",
	},
	{
		name: "L1 Blendmode",
		path: "LAYER 1/BLEND MODE/Value",
		type: "enum",
	},
	{
		name: "L1 LUT",
		path: "LAYER 1/LUT/Value",
		type: "integer",
	},
	{
		name: "L1 Playspeed",
		path: "LAYER 1/PLAY SPEED/Value",
		type: "float",
	},
	{
		name: "L1 Movementspeed",
		path: "LAYER 1/MOVEMENT SPEED/Value",
		type: "float",
	},
	{
		name: "L1 TC Hour",
		path: "LAYER 1/MTC HOUR/Value",
		type: "integer",
	},
	{
		name: "L1 TC Minute",
		path: "LAYER 1/MTC MINUTE/Value",
		type: "integer",
	},
	{
		name: "L1 TC Second",
		path: "LAYER 1/MTC SECOND/Value",
		type: "integer",
	},
	{
		name: "L1 TC Frame",
		path: "LAYER 1/MTC FRAME/Value",
		type: "integer",
	},
	{
		name: "L1 Scale",
		path: "LAYER 1/SCALE/Value",
		type: "float",
	},
	{
		name: "L1 Aspect",
		path: "LAYER 1/ASPECT RATIO/Value",
		type: "float",
	},
	{
		name: "L1 Position",
		pathx: "LAYER 1/POSITION X/Value",
		pathy: "LAYER 1/POSITION Y/Value",
		type: "point2d",
	},
	{
		name: "L1 Rotation",
		pathx: "LAYER 1/ROTATION X/Value",
		pathy: "LAYER 1/ROTATION Y/Value",
		pathz: "LAYER 1/ROTATION Z/Value",
		type: "point3d",
	},
	{
		name: "L1 RGB",
		pathx: "LAYER 1/RED/Value",
		pathy: "LAYER 1/GREEN/Value",
		pathz: "LAYER 1/BLUE/Value",
		type: "point3d",
	},
	{
		name: "L1 Hue",
		path: "LAYER 1/HUE/Value",
		type: "float",
	},
	{
		name: "L1 Saturation",
		path: "LAYER 1/SATURATION/Value",
		type: "float",
	},
	{
		name: "L1 Contrast",
		path: "LAYER 1/CONTRAST/Value",
		type: "float",
	},
	{
		name: "L1 Strobe",
		path: "LAYER 1/STROBE/Value",
		type: "float",
	},
	{
		name: "L1 Volume",
		path: "LAYER 1/VOLUME/Value",
		type: "float",
	},
	{
		name: "L1 Frameblending",
		path: "LAYER 1/FRAME BLENDING/Value",
		type: "boolean",
	},
	{
		name: "L1 Transition Duration",
		path: "LAYER 1/TRANSITION DURATION/Value",
		type: "integer",
	},
	{
		name: "L1 Transitionmode",
		path: "LAYER 1/TRANSITION MODE/Value",
		type: "enum",
	},
];
var l2ValuePaths = [
	{
		name: "L2 File",
		path: "LAYER 2/FILE SELECT/Value",
		type: "integer",
	},
	{
		name: "L2 Folder",
		path: "LAYER 2/FOLDER SELECT/Value",
		type: "integer",
	},
	{
		name: "L2 Intensity",
		path: "LAYER 2/INTENSITY/Value",
		type: "float",
	},
	{
		name: "L2 InFrame",
		path: "LAYER 2/IN FRAME/Value",
		type: "integer",
	},
	{
		name: "L2 OutFrame",
		path: "LAYER 2/OUT FRAME/Value",
		type: "integer",
	},
	{
		name: "L2 Playmode",
		path: "LAYER 2/PLAY MODE/Value",
		type: "enum",
	},
	{
		name: "L2 Framingmode",
		path: "LAYER 2/FRAMING MODE/Value",
		type: "enum",
	},
	{
		name: "L2 Blendmode",
		path: "LAYER 2/BLEND MODE/Value",
		type: "enum",
	},
	{
		name: "L2 LUT",
		path: "LAYER 2/LUT/Value",
		type: "integer",
	},
	{
		name: "L2 Playspeed",
		path: "LAYER 2/PLAY SPEED/Value",
		type: "float",
	},
	{
		name: "L2 Movementspeed",
		path: "LAYER 2/MOVEMENT SPEED/Value",
		type: "float",
	},
	{
		name: "L2 TC Hour",
		path: "LAYER 2/MTC HOUR/Value",
		type: "integer",
	},
	{
		name: "L2 TC Minute",
		path: "LAYER 2/MTC MINUTE/Value",
		type: "integer",
	},
	{
		name: "L2 TC Second",
		path: "LAYER 2/MTC SECOND/Value",
		type: "integer",
	},
	{
		name: "L2 TC Frame",
		path: "LAYER 2/MTC FRAME/Value",
		type: "integer",
	},
	{
		name: "L2 Scale",
		path: "LAYER 2/SCALE/Value",
		type: "float",
	},
	{
		name: "L2 Aspect",
		path: "LAYER 2/ASPECT RATIO/Value",
		type: "float",
	},
	{
		name: "L2 Position",
		pathx: "LAYER 2/POSITION X/Value",
		pathy: "LAYER 2/POSITION Y/Value",
		type: "point2d",
	},
	{
		name: "L2 Rotation",
		pathx: "LAYER 2/ROTATION X/Value",
		pathy: "LAYER 2/ROTATION Y/Value",
		pathz: "LAYER 2/ROTATION Z/Value",
		type: "point3d",
	},
	{
		name: "L2 RGB",
		pathx: "LAYER 2/RED/Value",
		pathy: "LAYER 2/GREEN/Value",
		pathz: "LAYER 2/BLUE/Value",
		type: "point3d",
	},
	{
		name: "L2 Hue",
		path: "LAYER 2/HUE/Value",
		type: "float",
	},
	{
		name: "L2 Saturation",
		path: "LAYER 2/SATURATION/Value",
		type: "float",
	},
	{
		name: "L2 Contrast",
		path: "LAYER 2/CONTRAST/Value",
		type: "float",
	},
	{
		name: "L2 Strobe",
		path: "LAYER 2/STROBE/Value",
		type: "float",
	},
	{
		name: "L2 Volume",
		path: "LAYER 2/VOLUME/Value",
		type: "float",
	},
	{
		name: "L2 Frameblending",
		path: "LAYER 2/FRAME BLENDING/Value",
		type: "boolean",
	},
	{
		name: "L2 Transition Duration",
		path: "LAYER 2/TRANSITION DURATION/Value",
		type: "integer",
	},
	{
		name: "L2 Transitionmode",
		path: "LAYER 2/TRANSITION MODE/Value",
		type: "enum",
	},
];

var valuesUpdating = false;

function init() {
	script.log("Hive Beeblade module init");
	getLatestLayerValues();
}

function moduleParameterChanged(param) {
	script.log(param.name + " parameter changed, new value: " + param.get());
	if (param.name === "deviceIP") {
		local.parameters.output.remoteHost.set(param.get());
		script.log("Device IP changed to: " + param.get());
		refreshLayerValues();
	}
}

function moduleValueChanged(value) {
	if (valuesUpdating) return; // Prevents infinite loop when updating values
	var parent = value.getParent().niceName;

	if (parent == "Playlist") {
		if (value.niceName == "Enabled") {
			setPlaylistEnabled(value.get());
			return;
		} else if (value.niceName == "Send To Workers") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Play List", [{"op":"replace","path":"/queenWorkerSync","value":' + value.get() + "}])";
			sendMessage(message);
			return;
		} else if (value.niceName == "Target Layer") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Play List", [{"op":"replace","path":"/targetLayer","value":' + value.get() + "}])";
			sendMessage(message);
			return;
		} else if (value.niceName == "Transition Time") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Play List", [{"op":"replace","path":"/transitionDuration","value":' + value.get() + "}])";
			sendMessage(message);
			return;
		}

	} else if (parent == "Timecode Cue List") {
		if (value.niceName == "Layer 1 Enabled") {
			setTCPlaylistEnabled(0, value.get());
		} else if (value.niceName == "Layer 2 Enabled") {
			setTCPlaylistEnabled(1, value.get());
		} else if (value.niceName == "Send To Workers") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/queenWorkerSync","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "Timecode Clock") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/clockSource","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "Timecode Offsets") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/offsetSource","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "Ignore Audio") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/ignoreAudio","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "Global Frame Adjustment") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/globalAdjust","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "TC Range Filter") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/useTCRangeFilter","value":' + value.get() + "}])";
			sendMessage(message);
		} else if (value.niceName == "Source IP") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/artnetTimecodeSourceIPAddress","value":"' + value.get() + '"}])"';
			sendMessage(message);
			script.log(message);
		} else if (value.niceName == "Glitch Protection") {
			var message =
				'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/useTCGlitchProtection","value":' + value.get() + "}])";
			sendMessage(message);
		}
	}
	else if (parent == "Layer 1" || parent == "Layer 2") {
		var paths =
			value.niceName.substring(0, 2) == "L1" ? l1ValuePaths : l2ValuePaths;

		for (i = 0; i < paths.length; i++) {
			var valPath = paths[i];
			var val = value.get();
			if (valPath.name === value.niceName) {
				if (valPath.type == "integer" || valPath.type == "enum") {
					var message =
						'localSVPatch.SetPatchDouble("' + valPath.path + '",' + val + ")";
					sendMessage(message);
					return;
				} else if (valPath.type == "float") {
					if (value.hasRange()) {
						var range = value.getRange();
						if (value.niceName == "L1 Scale" || value.niceName == "L2 Scale") {
							val = normalizeScaleFromValue(val);
						} else if (
							value.niceName == "L1 Playspeed" ||
							value.niceName == "L2 Playspeed"
						) {
							val = normalizePlaySpeedFromValue(val);
						} else {
							val = (val - range[0]) / (range[1] - range[0]);
						}
					}
					var message =
						'localSVPatch.SetPatchDouble("' + valPath.path + '",' + val + ")";
					sendMessage(message);
					return;
				} else if (valPath.type == "boolean") {
					var message =
						'localSVPatch.SetPatchDouble("' + valPath.path + '",' + val + ")";
					sendMessage(message);
				} else if (valPath.type == "point2d") {
					var vals = value.get();
					if (value.hasRange()) {
						var range = value.getRange();
						vals[0] = (vals[0] - range[0][0]) / (range[1][0] - range[0][0]);
						vals[1] = (vals[1] - range[0][1]) / (range[1][1] - range[0][1]);
					}
					var message =
						'localSVPatch.SetPatchDouble("' +
						valPath.pathx +
						'",' +
						vals[0] +
						")";
					sendMessage(message);
					var message =
						'localSVPatch.SetPatchDouble("' +
						valPath.pathy +
						'",' +
						vals[1] +
						")";
					sendMessage(message);
				} else if (valPath.type == "point3d") {
					var vals = value.get();
					if (value.hasRange()) {
						var range = value.getRange();
						vals[0] = (vals[0] - range[0][0]) / (range[1][0] - range[0][0]);
						vals[1] = (vals[1] - range[0][1]) / (range[1][1] - range[0][1]);
						vals[2] = (vals[2] - range[0][2]) / (range[1][2] - range[0][2]);
					}
					var message =
						'localSVPatch.SetPatchDouble("' +
						valPath.pathx +
						'",' +
						vals[0] +
						")";
					sendMessage(message);
					var message =
						'localSVPatch.SetPatchDouble("' +
						valPath.pathy +
						'",' +
						vals[1] +
						")";
					sendMessage(message);
					var message =
						'localSVPatch.SetPatchDouble("' +
						valPath.pathz +
						'",' +
						vals[2] +
						")";
					sendMessage(message);
				}
			}
		}
	}
}

function setPlaylistEnabled(enabled) {
	var message =
		'localSVPatch.UpdatePatchJSON("/Play List", [{"op":"replace","path":"/usePlayList","value":' + enabled + "}])";
	sendMessage(message);
}

function setTCPlaylistEnabled(layer, enabled) {
	var message =
		'localSVPatch.UpdatePatchJSON("/Timecode Cue List", [{"op":"replace","path":"/layers/' + layer + '/useCueList","value":' + enabled + "}])";
	sendMessage(message);
}
// Helpers
function sendMessage(message) {
	local.send(message + "\n");
}

// This is the callback function for the "Custom command" command
function customCmd(val) {
	script.log("Custom command called with value " + val);
	local.parameters.moduleParam.set(val);
}

function refreshLayerValues() {
	getLatestLayerValues();
}

function refreshModuleValues() {
	getLatestModuleValues();
}

function testCommand() {
	script.log("Sending test message");
	var message =
		'localSVPatch.GetPatchJSONWithDescriptor("/Play List",UDPMsgReturn)';
	sendMessage(message);
	script.log("Message sent");
}

function getLatestModuleValues() {
	var message =
		'localSVPatch.GetPatchJSON("/Play List",function(val){var ret = "' +
		local.name +
		'~playlist~"+JSON.stringify(val);UDPMsgReturn(ret + "|"); })';
	script.log(message);
	sendMessage(message);
}

function getLatestLayerValues() {
	for (i = 0; i < l1ValuePaths.length; i++) {
		var valPath = l1ValuePaths[i];
		if (
			valPath.type == "integer" ||
			valPath.type == "enum" ||
			valPath.type == "boolean" ||
			valPath.type == "float"
		) {
			var message =
				'localSVPatch.GetPatchDouble("' +
				valPath.path +
				'",function(val){var ret = "' +
				local.name +
				"~hval~/layerParameters/layer1~" +
				valPath.name +
				"~" +
				valPath.type +
				'~path~"+val;UDPMsgReturn(ret + "|"); })';
			sendMessage(message);
			continue;
		}

		var message =
			'localSVPatch.GetPatchDouble("' +
			valPath.pathx +
			'",function(val){var ret = "' +
			local.name +
			"~hval~/layerParameters/layer1~" +
			valPath.name +
			"~" +
			valPath.type +
			'~pathx~"+val;UDPMsgReturn(ret + "|");})';
		sendMessage(message);
		var message =
			'localSVPatch.GetPatchDouble("' +
			valPath.pathy +
			'",function(val){var ret = "' +
			local.name +
			"~hval~/layerParameters/layer1~" +
			valPath.name +
			"~" +
			valPath.type +
			'~pathy~"+val;UDPMsgReturn(ret + "|");})';
		sendMessage(message);
		if (valPath.type == "point3d") {
			var message =
				'localSVPatch.GetPatchDouble("' +
				valPath.pathz +
				'",function(val){var ret = "' +
				local.name +
				"~hval~/layerParameters/layer1~" +
				valPath.name +
				"~" +
				valPath.type +
				'~pathz~"+val;UDPMsgReturn(ret + "|");})';
			sendMessage(message);
			continue;
		}
	}

	for (i = 0; i < l2ValuePaths.length; i++) {
		var valPath = l2ValuePaths[i];
		if (
			valPath.type == "integer" ||
			valPath.type == "enum" ||
			valPath.type == "boolean" ||
			valPath.type == "float"
		) {
			var message =
				'localSVPatch.GetPatchDouble("' +
				valPath.path +
				'",function(val){var ret = "' +
				local.name +
				"~hval~/layerParameters/layer2~" +
				valPath.name +
				"~" +
				valPath.type +
				'~path~"+val;UDPMsgReturn(ret + "|"); })';
			sendMessage(message);
			continue;
		}

		var message =
			'localSVPatch.GetPatchDouble("' +
			valPath.pathx +
			'",function(val){var ret = "' +
			local.name +
			"~hval~/layerParameters/layer2~" +
			valPath.name +
			"~" +
			valPath.type +
			'~pathx~"+val;UDPMsgReturn(ret + "|");})';
		sendMessage(message);
		var message =
			'localSVPatch.GetPatchDouble("' +
			valPath.pathy +
			'",function(val){var ret = "' +
			local.name +
			"~hval~/layerParameters/layer2~" +
			valPath.name +
			"~" +
			valPath.type +
			'~pathy~"+val;UDPMsgReturn(ret + "|");})';
		sendMessage(message);
		if (valPath.type == "point3d") {
			var message =
				'localSVPatch.GetPatchDouble("' +
				valPath.pathz +
				'",function(val){var ret = "' +
				local.name +
				"~hval~/layerParameters/layer2~" +
				valPath.name +
				"~" +
				valPath.type +
				'~pathz~"+val;UDPMsgReturn(ret + "|");})';
			sendMessage(message);
			continue;
		}
	}
}

function dataReceived(data) {
	var entries = data.split("|");
	for (var i = 0; i < entries.length; i++) {
		var entry = entries[i];
		if (entry == "") continue;
		var parts = entry.split("~");
		if (parts.length > 2) {
			if (parts[0] != local.name) continue; // message is not for this module
			if (parts[1] == "hval") { // message is a layer value update
				var controlPath = parts[2];
				var name = parts[3];
				var type = parts[4];
				var pathname = parts[5];
				var value = parseFloat(parts[6]);
				updateValue(controlPath, name, type, pathname, value);
			} else if (parts[1] == "playlist") { // message is a playlist value update
				updatePlaylistValues(parts[2]);
			}
		}
	}
}

function setEnumFromValue(object, value) {
	object.set(getEnumKeyFramValue(object, value));
}

function getEnumKeyFramValue(object, value) {
	var options = object.getAllOptions();
	for (var i = 0; i < options.length; i++) {
		var opt = options[i];
		if (opt.value == value) {
			return opt.key;
		}
	}
	return null;
}

function updatePlaylistValues(jsonData) {
	valuesUpdating = true; // Prevents infinite loop
	var playlist = JSON.parse(jsonData);
	local.values.modules.playlist.enabled.set(playlist.usePlayList);
	local.values.modules.playlist.sendToWorkers.set(playlist.queenWorkerSync);
	setEnumFromValue(local.values.modules.playlist.targetLayer, playlist.targetLayer);
	setEnumFromValue(local.values.modules.playlist.transitionTime, playlist.transitionDuration);
	valuesUpdating = false; // Re-enable value updates
}

function updateValue(path, name, type, pathname, value) {
	valuesUpdating = true; // Prevents infinite loop
	var parent = local.values.getChild(path);
	var controllables = parent.getControllables();
	for (var j = 0; j < controllables.length; j++) {
		var controllable = controllables[j];
		if (controllable.niceName == name) {
			if (type == "integer" || type == "boolean") {
				controllable.set(value);
			}
			else if (type == "enum") {
				value = getEnumKeyFramValue(controllable, value);
				controllable.set(value);
			}
			else if (type == "float") {
				if (name == "L1 Scale" || name == "L2 Scale") {
					value = calculateScaleFromNormalised(value);
				} else if (name == "L1 Playspeed" || name == "L2 Playspeed") {
					value = calculatePlaySpeedFromNormalised(value);
				} else {
					if (controllable.hasRange()) {
						var range = controllable.getRange();
						value = range[0] + value * (range[1] - range[0]);
					}
				}
				controllable.set(value);
			}
			else if (type == "point2d") {
				var vals = controllable.get();
				var x = vals[0];
				var y = vals[1];
				if (controllable.hasRange()) {
					var range = controllable.getRange();
					if (pathname === "pathx") {
						x = (range[1][0] - range[0][0]) * value + range[0][0];
						y = (range[1][1] - range[0][1]) * vals[1] + range[0][1];
					} else if (pathname === "pathy") {
						x = (range[1][0] - range[0][0]) * vals[0] + range[0][0];
						y = (range[1][1] - range[0][1]) * value + range[0][1];
					}
				} else {
					if (pathname === "pathx") {
						x = value;
					} else if (pathname === "pathy") {
						y = value;
					}
				}
				controllable.set(x, y);
			}
			else if (type == "point3d") {
				var vals = controllable.get();
				var x = vals[0];
				var y = vals[1];
				var z = vals[2];
				if (controllable.hasRange()) {
					var range = controllable.getRange();
					if (pathname === "pathx") {
						x = (range[1][0] - range[0][0]) * value + range[0][0];
						y = (range[1][1] - range[0][1]) * vals[1] + range[0][1];
						z = (range[1][2] - range[0][2]) * vals[2] + range[0][2];
					} else if (pathname === "pathy") {
						x = (range[1][0] - range[0][0]) * vals[0] + range[0][0];
						y = (range[1][1] - range[0][1]) * value + range[0][1];
						z = (range[1][2] - range[0][2]) * vals[2] + range[0][2];
					} else if (pathname === "pathz") {
						x = (range[1][0] - range[0][0]) * vals[0] + range[0][0];
						y = (range[1][1] - range[0][1]) * vals[1] + range[0][1];
						z = (range[1][2] - range[0][2]) * value + range[0][2];
					}
				} else {
					if (pathname === "pathx") {
						x = value;
					} else if (pathname === "pathy") {
						y = value;
					} else if (pathname === "pathz") {
						z = value;
					}
				}
				controllable.set(x, y, z);
			}
		}
	}
	valuesUpdating = false; // Re-enable value updates
}

function normalizeScaleFromValue(scale) {
	var newVal = 0.0;
	if (scale <= 100) {
		newVal = (scale / 100.0) * 0.5;
	} // 0 -> 0.5
	else {
		newVal = 0.5 + ((scale - 100) / 900.0) * 0.5;
	} // 0.5 -> 1.0

	return newVal;
}

function calculateScaleFromNormalised(scalenormalised) {
	var newVal = 0.0;

	if (scalenormalised < 0.5) {
		newVal = scalenormalised * 200.0;
	} // 0..100
	else {
		newVal = 100.0 + ((scalenormalised - 0.5) / 0.5) * 900.0;
	} // 100.. 1000

	return newVal;
}

function normalizePlaySpeedFromValue(playspeed) {
	var newVal = 0.0;

	if (playspeed <= 100) {
		newVal = (playspeed / 100.0) * 0.5;
	} // 0 -> 0.5
	else {
		newVal = 0.5 + ((playspeed - 100.0) / 900.0) * 0.5;
	} // 0.5 -> 1.0

	return newVal;
}

function calculatePlaySpeedFromNormalised(playspeednormalised) {
	var newVal = 0.0;

	if (playspeednormalised < 0.5) {
		newVal = playspeednormalised * 200.0;
	} // 0..100
	else {
		newVal = 100.0 + ((playspeednormalised - 0.5) / 0.5) * 900.0;
	} // 100.. 1000

	return Math.round(newVal);
}
